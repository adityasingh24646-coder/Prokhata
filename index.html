<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>डिजिटल हिसाब प्रो</title>

    <!-- <<< नया: ऐप आइकॉन के लिए लिंक >>> -->
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        :root {
            --primary-color: #3a7bd5;
            --primary-gradient: linear-gradient(to right, #3a61bd, #00d2ff);
            --accent-color: #f5af19;
            --accent-gradient: linear-gradient(to right, #f12711, #f5af19);
            --danger-color: #e63946;
            --success-color: #2a9d8f;
            --bg-color: #f7f8fc;
            --card-bg: #ffffff;
            --text-dark: #2b2d42;
            --text-light: #8d99ae;
            --border-color: #e9ecef;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --radius: 16px;
        }
        body.dark-mode {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-dark: #e0e0e0;
            --text-light: #888888;
            --border-color: #333333;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap');
        
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            text-align: center;
            transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
            opacity: 1;
            visibility: visible;
        }
        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .splash-content {
            animation: pop-in-splash 0.7s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        @keyframes pop-in-splash {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .splash-content h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .splash-content p {
            font-size: 1rem;
            letter-spacing: 2px;
            opacity: 0.8;
            font-weight: 600;
        }

        body { font-family: 'Manrope', sans-serif; background-color: var(--bg-color); color: var(--text-dark); margin: 0; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .main-header { display: flex; justify-content: space-between; align-items: center; padding: 25px 20px; margin-bottom: 30px; background: var(--primary-gradient); color: white; border-radius: var(--radius); text-align: center; box-shadow: 0 10px 20px -5px rgba(58,123,213,0.5); }
        .main-header h1 { margin: 0; font-size: 2rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 34px; position: relative; width: 60px; }
        .theme-switch input { display:none; }
        .slider { background-color: #557ec9; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 26px; left: 4px; position: absolute; transition: .4s; width: 26px; }
        input:checked + .slider { background-color: #303136; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .dashboard-card { background: var(--card-bg); padding: 25px; border-radius: var(--radius); display: flex; align-items: center; gap: 20px; box-shadow: var(--shadow); transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .dashboard-card .icon { font-size: 2.5rem; padding: 15px; border-radius: 50%; background-color: var(--bg-color); transition: background-color 0.3s; }
        .dashboard-card .value { font-size: 1.8rem; font-weight: 700; }
        #totalCustomersIcon { color: var(--primary-color); } #totalDueIcon { color: var(--danger-color); }
        .toolbar { display: flex; margin-bottom: 20px; }
        #search-box { flex-grow: 1; padding: 15px 20px; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 1rem; color: var(--text-dark); background: var(--card-bg) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%238d99ae" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>') no-repeat 15px center; padding-left: 45px; transition: all 0.3s; }
        #search-box:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(58,123,213,0.2); outline: none; }
        body.dark-mode #search-box { background-color: var(--card-bg); }
        #customer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .customer-card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 25px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s; border-top: 4px solid var(--primary-color); }
        .customer-card:hover { transform: translateY(-8px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .customer-card .name { font-size: 1.4rem; font-weight: 700; color: var(--text-dark); }
        .customer-card .balance-label { font-size: 0.9rem; color: var(--text-light); margin-top: 15px; }
        .customer-card .balance-amount { font-size: 2rem; font-weight: 700; letter-spacing: -1px; }
        .due-positive { color: var(--danger-color); } .due-zero, .due-negative { color: var(--success-color); }
        .empty-state { text-align: center; color: var(--text-light); padding: 60px; grid-column: 1 / -1; background: var(--card-bg); border-radius: var(--radius); transition: background-color 0.3s;}
        .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column-reverse; align-items: center; gap: 15px; z-index: 999; }
        .fab { width: 64px; height: 64px; color: white; border-radius: 50%; border: none; box-shadow: 0 6px 15px rgba(0,0,0,0.25); font-size: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        #add-fab { background: var(--accent-gradient); }
        #voice-fab { background: var(--primary-gradient); }
        .fab:hover { transform: scale(1.1) rotate(15deg); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        #voice-fab.listening { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(58,123,213,0.7); } 70% { box-shadow: 0 0 0 25px rgba(58,123,213,0); } 100% { box-shadow: 0 0 0 0 rgba(58,123,213,0); } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(30, 30, 30, 0.5); backdrop-filter: blur(8px); align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .modal-content { background: var(--card-bg); border-radius: var(--radius); width: 90%; max-width: 550px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: pop-in 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pop-in { from { transform: translateY(20px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .modal-header { background: var(--primary-gradient); color: white; padding: 20px 25px; border-bottom: none; border-radius: var(--radius) var(--radius) 0 0; display: flex; justify-content: space-between; align-items: center;}
        .modal-header h2 { font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); margin:0; }
        .close-btn { font-size: 2rem; color: white; opacity: 0.8; cursor: pointer; transition: all 0.2s; line-height: 1; }
        .close-btn:hover { opacity: 1; transform: rotate(90deg) scale(1.1); }
        .modal-body { padding: 25px; }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark); }
        input { width: 100%; padding: 15px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 1rem; box-sizing: border-box; transition: all 0.2s; background-color: var(--bg-color); color: var(--text-dark); }
        input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(58,123,213,0.2); outline: none; }
        .btn { border-radius: 12px; font-weight: 600; padding: 15px; text-transform: uppercase; letter-spacing: 0.5px; transition: transform 0.2s, box-shadow 0.2s; color: white; border: none; cursor: pointer;}
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .btn-accent { background: var(--accent-gradient); }
        .btn-danger { background: var(--danger-color); }
        .btn-secondary { background: var(--text-light); }
        .profile-footer .btn { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .form-buttons { display: flex; gap: 10px; margin-top: 20px; }
        #transactionHistory { list-style: none; padding: 0; margin-top: 15px; max-height: 300px; overflow-y: auto; }
        #transactionHistory li { display: flex; align-items: center; padding: 15px 5px; border-bottom: 1px solid var(--border-color); }
        .tx-details { flex-grow: 1; } .tx-desc { font-weight: 600; }
        .tx-date { font-size: 0.85rem; color: var(--text-light); }
        .tx-amount { font-weight: 700; text-align: right; margin-right: 15px; font-size: 1.1rem; }
        .tx-delete { background: #fee2e2; color: #ef4444; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; transition: all 0.2s; }
        .tx-delete:hover { background: #ef4444; color: white; transform: scale(1.1) rotate(90deg); }
        body.dark-mode .tx-delete { background: #3a1a1a; color: #e63946; }
        body.dark-mode .tx-delete:hover { background: #e63946; color: white; }
        .data-management { margin-top: 40px; text-align: center; padding: 25px; background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); transition: background-color 0.3s; }
        .data-management button { display: inline-block; width: auto; margin: 10px; }
        #importBackupInput { display: none; }
        
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 50px; color: white; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }

        #confirmModal .modal-content { max-width: 400px; }
        #confirmModalBody { padding: 25px; text-align: center; }
        #confirmMessage { font-size: 1.1rem; margin-bottom: 25px; line-height: 1.6; }
        #confirmButtons { display: flex; justify-content: center; gap: 15px; }
        #confirmButtons button { padding: 12px 25px; }

        @media print {
            body, .container, .fab-container, .theme-switch-wrapper, .modal, #splash-screen { display: none; }
            #print-container, #print-container * { display: block !important; }
            #print-container { position: absolute; left: 0; top: 0; width: 100%; color: black; background: white;}
            @page { size: A4; margin: 20mm; }
            h1, h2, h3 { color: black; text-align: center; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-content">
            <h1>डिजिटल हिसाब प्रो</h1>
            <p>DEVELOPED BY ADITYA SINGH</p>
        </div>
    </div>

    <div id="app-container">
        <div class="container">
            <header class="main-header">
                <h1>डिजिटल हिसाब प्रो</h1>
                <div class="theme-switch-wrapper">
                    <label class="theme-switch" for="checkbox">
                        <input type="checkbox" id="checkbox" />
                        <div class="slider round"></div>
                    </label>
                </div>
            </header>
            <div class="dashboard"></div>
            <div class="toolbar"><input type="text" id="search-box" onkeyup="filterCustomers()" placeholder="किसी भी ग्राहक को खोजें..."></div>
            <div id="customer-grid"></div>
            <div class="data-management"></div>
        </div>
        <div class="fab-container"></div>
    </div>
    
    <div id="addTransactionModal" class="modal"></div>
    <div id="customerProfileModal" class="modal"></div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <header class="modal-header"><h2 id="confirmTitle">पुष्टि करें</h2></header>
            <div id="confirmModalBody">
                <p id="confirmMessage"></p>
                <div id="confirmButtons">
                    <button id="confirmYes" class="btn btn-danger">हाँ</button>
                    <button id="confirmNo" class="btn btn-secondary">नहीं</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>
    <div id="print-container" style="display:none;"></div>

    <script>
    (() => {
        const SHOP_NAME = "डिजिटल हिसाब प्रो";
        const DB_NAME = 'myDukaanAppFinal';
        
        document.addEventListener('DOMContentLoaded', () => {
            const splashScreen = document.getElementById('splash-screen');
            setTimeout(() => {
                splashScreen.classList.add('hidden');
            }, 2500);

            setupInitialHTML();
            applyInitialTheme();
            renderUI();
            setupEventListeners();
            setupVoiceRecognition();
        });

        function setupInitialHTML() {
            document.querySelector('.dashboard').innerHTML = `<div class="dashboard-card"><div class="icon" id="totalCustomersIcon">👥</div><div><div class="title">कुल ग्राहक</div><div class="value" id="totalCustomers">0</div></div></div><div class="dashboard-card"><div class="icon" id="totalDueIcon">💰</div><div><div class="title">कुल लेन-दारी (बकाया)</div><div class="value due-positive" id="totalDue">₹0</div></div></div>`;
            document.querySelector('.data-management').innerHTML = `<h3>डेटा मैनेजमेंट</h3><button class="btn btn-secondary" onclick="exportData()">बैकअप लें</button><button class="btn btn-secondary" onclick="document.getElementById('importBackupInput').click()">बैकअप डालें</button><input type="file" id="importBackupInput" accept=".json" onchange="importData(event)">`;
            document.querySelector('.fab-container').innerHTML = `<button class="fab" id="voice-fab" title="बोलकर खाता जोड़ें"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/><path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/></svg></button><button class="fab" id="add-fab" onclick="openAddTransactionModal()" title="नया खाता जोड़ें"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>`;
            document.getElementById('addTransactionModal').innerHTML = `<div class="modal-content"><header class="modal-header"><h2 id="modalTitle">नया हिसाब जोड़ें</h2><span class="close-btn" onclick="closeModal('addTransactionModal')">×</span></header><div class="modal-body"><form id="transactionForm"><div class="form-group"><label for="customerName">ग्राहक का नाम</label><input type="text" id="customerName" list="customerSuggestions" required></div><datalist id="customerSuggestions"></datalist><div class="form-group"><label for="itemName">उधार का विवरण</label><input type="text" id="itemName" placeholder="जैसे - 'चूड़ी का सेट'"></div><div class="form-group"><label for="itemPrice">उधार राशि (₹)</label><input type="number" id="itemPrice" placeholder="0" min="0"></div><div class="form-group"><label for="amountPaid">जमा राशि (₹)</label><input type="number" id="amountPaid" placeholder="0" min="0"></div><div class="form-buttons"><button class="btn btn-accent" type="submit">सेव करें</button><button class="btn btn-secondary" type="reset">क्लियर</button></div></form></div></div>`;
            document.getElementById('customerProfileModal').innerHTML = `<div class="modal-content"><div id="printable-area"><header class="modal-header"><h2 id="profileCustomerName"></h2><span class="close-btn no-print" onclick="closeModal('customerProfileModal')">×</span></header><div class="modal-body"><h3>कुल बकाया: <span id="profileTotalDue"></span></h3><ul id="transactionHistory"></ul></div></div><div class="modal-body profile-footer no-print"><button id="addToProfileBtn" class="btn btn-accent">नया लेन-देन</button><button class="btn btn-secondary" onclick="printHisab()">प्रिंट / शेयर</button><button id="deleteCustomerBtn" class="btn btn-danger" style="grid-column: 1 / -1;">ग्राहक को हटाएं</button></div></div>`;
        }
        
        function setupEventListeners() {
            document.getElementById('transactionForm').addEventListener('submit', handleFormSubmit);
            window.addEventListener('click', (e) => { if (e.target.classList.contains('modal') && e.target.id !== 'confirmModal') closeModal(e.target.id); });
            const themeSwitch = document.getElementById('checkbox');
            themeSwitch.addEventListener('change', () => {
                if (themeSwitch.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });
        }

        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('checkbox').checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('checkbox').checked = false;
            }
        }

        function setupVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                const recognition = new SpeechRecognition();
                const voiceFab = document.getElementById('voice-fab');
                recognition.lang = 'hi-IN';
                recognition.continuous = false;
                
                voiceFab.onclick = () => recognition.start();
                recognition.onstart = () => voiceFab.classList.add('listening');
                recognition.onspeechend = () => voiceFab.classList.remove('listening');
                recognition.onerror = (e) => { voiceFab.classList.remove('listening'); console.error('Voice Error:', e.error); };
                recognition.onresult = (event) => parseVoiceCommand(event.results[0][0].transcript);
            } else {
                document.getElementById('voice-fab').style.display = 'none';
            }
        }

        function parseVoiceCommand(text) {
            let name = '', item = '', price = 0, paid = 0;
            const words = text.split(' ');
            name = words[0] || '';
            const priceMatch = text.match(/(\d+)\s*(?:रुपये का|का)/);
            const paidMatch = text.match(/(\d+)\s*(?:जमा|दिए)/);
            if (priceMatch) price = parseInt(priceMatch[1], 10);
            if (paidMatch) paid = parseInt(paidMatch[1], 10);
            const a = text.indexOf(words[0]);
            const b = text.indexOf('रुपये का');
            if (b > a) {
                let potentialItem = text.substring(a + words[0].length, b).replace('ने', '').trim();
                item = potentialItem;
            }
            openAddTransactionModal();
            document.getElementById('customerName').value = name;
            document.getElementById('itemName').value = item;
            document.getElementById('itemPrice').value = price || '';
            document.getElementById('amountPaid').value = paid || '';
            showToast('फॉर्म भर दिया गया है। जांच कर सेव करें।', 'success');
        }

        function getCustomers() {
            try { return JSON.parse(localStorage.getItem(DB_NAME)) || {}; }
            catch (e) { showToast("डेटा पढ़ने में त्रुटि हुई!", "error"); return {}; }
        }

        function saveCustomers(customers) {
            try { localStorage.setItem(DB_NAME, JSON.stringify(customers)); renderUI(); }
            catch (e) { showToast("डेटा सहेजने में त्रुटि हुई!", "error"); }
        }
        
        function calculateTotalDue(transactions) { return transactions.reduce((t, tx) => t + (tx.type === 'udhaar' ? tx.amount : -tx.amount), 0); }
        
        function renderUI() {
             const customers = getCustomers();
            const customerGrid = document.getElementById('customer-grid');
            const customerSuggestions = document.getElementById('customerSuggestions');
            customerGrid.innerHTML = '';
            customerSuggestions.innerHTML = '';
            
            const sortedNames = Object.keys(customers).sort((a,b) => a.localeCompare(b,'hi'));
            if (sortedNames.length === 0) {
                customerGrid.innerHTML = `<div class="empty-state"><h3>कोई ग्राहक नहीं मिला।</h3><p>शुरू करने के लिए नीचे दिए गए '+' बटन का उपयोग करें।</p></div>`;
            } else {
                sortedNames.forEach(name => {
                    customerSuggestions.innerHTML += `<option value="${name}">`;
                    const totalDue = calculateTotalDue(customers[name].transactions);
                    const card = document.createElement('div');
                    card.className = 'customer-card';
                    card.dataset.name = name;
                    card.onclick = () => showCustomerProfile(name);
                    card.innerHTML = `<div class="name">${name}</div><div class="balance-label">कुल बकाया</div><div class="balance-amount ${totalDue > 0 ? 'due-positive' : 'due-zero'}">₹${totalDue.toFixed(2)}</div>`;
                    customerGrid.appendChild(card);
                });
            }
            updateDashboard();
        }

        function updateDashboard() {
            const customers = getCustomers();
            const customerCount = Object.keys(customers).length;
            const totalDue = Object.values(customers).reduce((total, cust) => total + calculateTotalDue(cust.transactions), 0);
            document.getElementById('totalCustomers').textContent = customerCount;
            document.getElementById('totalDue').textContent = `₹${totalDue.toFixed(2)}`;
        }

        function filterCustomers() {
            const filter = document.getElementById('search-box').value.toUpperCase();
            document.querySelectorAll('.customer-card').forEach(card => {
                card.style.display = card.dataset.name.toUpperCase().includes(filter) ? '' : 'none';
            });
        }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openAddTransactionModal() {
            document.getElementById('transactionForm').reset();
            document.getElementById('customerName').readOnly = false;
            document.getElementById('modalTitle').textContent = 'नया हिसाब जोड़ें';
            openModal('addTransactionModal');
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const customerName = document.getElementById('customerName').value.trim();
            const itemName = document.getElementById('itemName').value.trim();
            const itemPrice = parseFloat(document.getElementById('itemPrice').value) || 0;
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;

            if (itemPrice < 0 || amountPaid < 0) {
                showToast("राशि नेगेटिव नहीं हो सकती।", "error"); return;
            }
            if (!customerName || (itemPrice === 0 && amountPaid === 0)) {
                showToast("ग्राहक का नाम और कोई राशि ज़रूर डालें।", "error"); return;
            }

            const customers = getCustomers();
            if (!customers[customerName]) customers[customerName] = { transactions: [] };
            const timestamp = new Date().toLocaleString('hi-IN', {day:'numeric',month:'short',year:'numeric',hour:'numeric',minute:'2-digit'});
            
            if (itemPrice > 0) customers[customerName].transactions.push({id: generateUniqueId(), type: 'udhaar', description: itemName||'सामान', amount: itemPrice, date: timestamp});
            if (amountPaid > 0) customers[customerName].transactions.push({id: generateUniqueId(), type: 'jama', description: 'पैसे जमा किये', amount: amountPaid, date: timestamp});
            
            saveCustomers(customers);
            closeModal('addTransactionModal');
            showToast("हिसाब सफलतापूर्वक सेव हो गया!", "success");

            if (document.getElementById('customerProfileModal').style.display === 'flex' && document.getElementById('profileCustomerName').textContent === customerName) {
                showCustomerProfile(customerName);
            }
        }

        function showCustomerProfile(name) {
            const customer = getCustomers()[name];
            document.getElementById('profileCustomerName').textContent = name;
            const totalDue = calculateTotalDue(customer.transactions);
            document.getElementById('profileTotalDue').innerHTML = `<span class="${totalDue > 0 ? 'due-positive' : 'due-zero'}">₹${totalDue.toFixed(2)}</span>`;
            const historyList = document.getElementById('transactionHistory');
            historyList.innerHTML = '';
            customer.transactions.slice().reverse().forEach(tx => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="tx-details"><div class="tx-desc">${tx.description}</div><div class="tx-date">${tx.date}</div></div><div class="tx-amount ${tx.type === 'udhaar' ? 'due-positive' : 'due-zero'}">${tx.type === 'udhaar' ? '+' : '-'} ₹${tx.amount.toFixed(2)}</div><div class="tx-delete" onclick="deleteTransaction('${name}', '${tx.id}')">✖</div>`;
                historyList.appendChild(li);
            });
            document.getElementById('addToProfileBtn').onclick = () => { closeModal('customerProfileModal'); openAddTransactionModal(); const customerNameInput = document.getElementById('customerName'); customerNameInput.value = name; customerNameInput.readOnly = true; document.getElementById('modalTitle').textContent = `${name} के खाते में जोड़ें`; };
            document.getElementById('deleteCustomerBtn').onclick = () => deleteCustomer(name);
            openModal('customerProfileModal');
        }

        window.deleteTransaction = function(customerName, txId) {
            showConfirm("क्या आप वाकई इस लेन-देन को हटाना चाहते हैं?", () => {
                const customers = getCustomers();
                customers[customerName].transactions = customers[customerName].transactions.filter(tx => tx.id !== txId);
                saveCustomers(customers);
                showCustomerProfile(customerName);
                showToast("लेन-देन हटा दिया गया है।", "success");
            });
        }

        window.deleteCustomer = function(name) {
            const message = `सावधान! क्या आप ग्राहक "${name}" और उनके सारे हिसाब को हमेशा के लिए हटाना चाहते हैं? यह वापस नहीं लाया जा सकेगा।`;
            showConfirm(message, () => {
                const customers = getCustomers();
                delete customers[name];
                saveCustomers(customers);
                closeModal('customerProfileModal');
                showToast(`ग्राहक "${name}" को हटा दिया गया है।`, "success");
            });
        }
        
        window.printHisab = function() {
            const name = document.getElementById('profileCustomerName').textContent;
            const customer = getCustomers()[name];
            const totalDue = calculateTotalDue(customer.transactions);
            let tableRows = customer.transactions.map(tx => `<tr><td>${tx.date}</td><td>${tx.description}</td><td>${tx.type === 'udhaar' ? `₹${tx.amount.toFixed(2)}` : '-'}</td><td>${tx.type === 'jama' ? `₹${tx.amount.toFixed(2)}` : '-'}</td></tr>`).join('');
            const printContent = `<h1>${SHOP_NAME}</h1><h2>ग्राहक का हिसाब</h2><p><strong>ग्राहक:</strong> ${name}</p><hr><table><thead><tr><th>तारीख</th><th>विवरण</th><th>उधार</th><th>जमा</th></tr></thead><tbody>${tableRows}</tbody></table><hr><h3>कुल बकाया: ₹${totalDue.toFixed(2)}</h3>`;
            document.getElementById('print-container').innerHTML = printContent;
            window.print();
        }

        window.exportData = function() {
            const customers = getCustomers();
            if (Object.keys(customers).length === 0) { showToast("निर्यात करने के लिए कोई डेटा नहीं है!", "error"); return; }
            const dataStr = JSON.stringify(customers);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `dukaan-backup-${new Date().toISOString().slice(0,10)}.json`;
            a.click(); URL.revokeObjectURL(url);
        }

        window.importData = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const message = "चेतावनी: ऐसा करने से आपका मौजूदा सारा डेटा हट जाएगा और उसकी जगह इस बैकअप का डेटा आ जाएगा!";
            showConfirm(message, () => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (typeof imported === 'object' && imported !== null && !Array.isArray(imported)) {
                            saveCustomers(imported);
                            showToast("डेटा सफलतापूर्वक आयात हो गया है!", "success");
                        } else {
                            throw new Error("Invalid format");
                        }
                    } catch (err) {
                        showToast("त्रुटि: यह एक मान्य बैकअप फ़ाइल नहीं है।", "error");
                    }
                };
                reader.readAsText(file);
            });
            event.target.value = null;
        }
        
        function generateUniqueId() {
            return 'tx-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        function showConfirm(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmMessage').textContent = message;
            modal.style.display = 'flex';
            const yesHandler = () => { onConfirm(); cleanup(); };
            const noHandler = () => cleanup();
            const cleanup = () => {
                modal.style.display = 'none';
                document.getElementById('confirmYes').removeEventListener('click', yesHandler);
                document.getElementById('confirmNo').removeEventListener('click', noHandler);
            };
            document.getElementById('confirmYes').addEventListener('click', yesHandler, { once: true });
            document.getElementById('confirmNo').addEventListener('click', noHandler, { once: true });
        }
        
        window.openAddTransactionModal = openAddTransactionModal;
        window.closeModal = closeModal;
        window.filterCustomers = filterCustomers;
        window.showCustomerProfile = showCustomerProfile;

    })();
    </script>
</body>
</html>